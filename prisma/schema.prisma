// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}


model User {
  id            String    @id @default(uuid())
  name          String
  email         String    @unique
  username      String    @unique
  password      String?
  phone         String?
  bio           String?
  avatar        String?
  coverImage    String?
  
  // Platform customization
  brandColor    String?   @default("#0ea5e9")
  website       String?
  facebook      String?
  instagram     String?
  twitter       String?
  
  // Bank/Wallet info
  bankName      String?
  accountNumber String?
  accountName   String?
  
  // Seller Balance (Escrow System)
  pendingBalance    Float    @default(0)  // أرباح معلقة (طلبات أقل من 7 أيام)
  availableBalance  Float    @default(0)  // متاح للسحب
  totalEarnings     Float    @default(0)  // إجمالي الأرباح
  
  // Payout Settings
  payoutMethod      String?  // "bank" | "paypal" | "crypto"
  bankDetails       Json?    // {bankName, accountNumber, iban, swift}
  paypalEmail       String?
  cryptoWallet      String?  // USDT address
  
  // Affiliate
  affiliateCode String?   @unique
  
  // Manual Payment Settings (للبائع)
  shamCashNumber    String?
  omtNumber         String?
  zainCashNumber    String?
  vodafoneCash      String?
  mtncashNumber     String?
  
  // Appointments
  consultationPrice Float?   @default(0)
  
  role          Role      @default(SELLER)
  isActive      Boolean   @default(true)
  emailVerified Boolean   @default(false)
  isVerified    Boolean   @default(false)  // Blue checkmark badge
  preferredLanguage String @default("ar")  // ar, en, es
  
  // Google Calendar Integration
  googleCalendarAccessToken  String?
  googleCalendarRefreshToken String?
  googleCalendarTokenExpiry  DateTime?
  googleCalendarConnected    Boolean  @default(false)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  products      Product[]
  courses       Course[]
  appointments  Appointment[]
  orders        Order[]
  payouts       Payout[]  @relation("SellerPayouts")
  coupons       Coupon[]
  affiliateLinks AffiliateLink[]
  affiliateReferrals AffiliateReferral[]
  subscriptionPlans SubscriptionPlan[]
  subscriptions Subscription[] @relation("CustomerSubscriptions")
  sellerOrders  Order[]  @relation("SellerOrders")
  verifiedOrders Order[] @relation("OrderVerifier")
  availabilities Availability[]
}

model Product {
  id          String   @id @default(uuid())
  title       String
  slug        String?  // URL-friendly slug for direct linking
  description String
  price       Float
  image       String?
  fileUrl     String?  // رابط الملف الرقمي
  fileType    String?  @default("pdf") // pdf, video, zip, etc.
  
  category    String?
  tags        String[] @default([])
  
  // New fields
  isFree      Boolean  @default(false) // منتج مجاني
  isActive    Boolean  @default(true)  // نشط أو مخفي
  displayOrder Int     @default(0)     // ترتيب العرض
  duration    String?                  // مدة الدورة
  sessions    Int?                     // عدد الجلسات
  features    String[] @default([])    // مميزات المنتج
  
  // Pay What You Want (PWYW) Pricing
  minPrice    Float?   @default(0)     // الحد الأدنى للسعر (0 = free choice)
  suggestedPrice Float?                // السعر المقترح
  
  // Scarcity & Urgency Features
  stockLimit  Int?                     // حد المخزون (null = unlimited)
  soldCount   Int      @default(0)     // عدد المبيعات
  offerExpiresAt DateTime?             // تاريخ انتهاء العرض
  
  // Reviews
  averageRating Float?   @default(0)
  reviewCount   Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  orderItems  OrderItem[]
  affiliateLinks AffiliateLink[]
  reviews     Review[]

  @@unique([userId, slug]) // Unique slug per creator
  @@index([userId])
  @@index([slug])
}

model Course {
  id          String   @id @default(uuid())
  title       String
  description String
  price       Float
  image       String?
  
  // Course details
  duration    String?  // "4 أسابيع"
  level       String?  // مبتدئ، متوسط، متقدم
  
  // Platform links
  zoomLink    String?
  meetLink    String?
  
  // Schedule
  startDate   DateTime?
  endDate     DateTime?
  sessions    Int?     // عدد الجلسات
  
  category    String?
  tags        String[]
  
  isActive    Boolean  @default(true)
  isCertificateEnabled Boolean @default(false) // شهادة التخرج اختيارية
  
  // New settings
  allowComments Boolean @default(true)
  requiresQuiz  Boolean @default(false)
  certificateTemplate String? // قالب الشهادة المخصص
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  orderItems  OrderItem[]
  enrollments CourseEnrollment[]
  modules     Module[]
  quizzes     Quiz[]
  certificates Certificate[]
  affiliateLinks AffiliateLink[]
}

model Appointment {
  id          String   @id @default(uuid())
  title       String
  description String?
  price       Float
  duration    Int      // بالدقائق
  
  // Meeting details
  date        DateTime
  meetingLink String?
  status      AppointmentStatus @default(PENDING)
  
  // Customer info
  customerName  String?
  customerEmail String?
  customerPhone String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  orderId     String?
  order       Order?   @relation(fields: [orderId], references: [id])
}

model Availability {
  id          String   @id @default(uuid())
  
  dayOfWeek   Int      // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
  startTime   String   // e.g. "09:00"
  endTime     String   // e.g. "17:00"
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, dayOfWeek])
  @@index([userId])
}

model Order {
  id          String      @id @default(uuid())
  orderNumber String      @unique
  
  // Customer info
  customerName  String
  customerEmail String
  customerPhone String?
  totalAmount   Float
  status        OrderStatus @default(PENDING)
  
  // Commission & Escrow Fields
  platformFee       Float    @default(0)    // عمولة المنصة
  sellerAmount      Float    @default(0)    // حصة البائع
  
  // Seller Info
  sellerId          String?
  seller            User?    @relation("SellerOrders", fields: [sellerId], references: [id])
  
  // Payout Info
  payoutStatus      String   @default("pending")  // "pending" | "available" | "paid_out"
  availableAt       DateTime?                     // متى يصبح متاح للسحب
  paidOutAt         DateTime?
  payoutId          String?
  payout            Payout?  @relation(fields: [payoutId], references: [id])
  
  // Payment info
  paymentMethod String?
  paymentId     String?
  isPaid        Boolean   @default(false)
  paidAt        DateTime?
  
  // Manual Payment Fields
  paymentProof      String?   // رابط صورة الإيصال
  paymentNotes      String?   // ملاحظات من المشتري
  senderPhone       String?   // رقم المرسل
  transactionRef    String?   // رقم العملية
  paymentCountry    String?   // الدولة
  paymentProvider   String?   // "shamcash" | "omt" | "zaincash" etc
  
  // Verification
  verifiedBy        String?
  verifier          User?     @relation("OrderVerifier", fields: [verifiedBy], references: [id])
  verifiedAt        DateTime?
  rejectionReason   String?
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Coupon & Discount
  couponId    String?
  coupon      Coupon?  @relation(fields: [couponId], references: [id])
  discount    Float    @default(0)
  
  // Affiliate
  affiliateLinkId String?
  affiliateLink   AffiliateLink? @relation(fields: [affiliateLinkId], references: [id])
  
  // Relations
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  items       OrderItem[]
  appointments Appointment[]
  affiliateReferral AffiliateReferral?
  
  couponUsages   CouponUsage[]
  affiliateSales AffiliateSale[]
}

model OrderItem {
  id        String   @id @default(uuid())
  quantity  Int      @default(1)
  price     Float
  
  itemType  String   // "product" or "course"
  
  // Relations
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  productId String?
  product   Product? @relation(fields: [productId], references: [id])
  
  courseId  String?
  course    Course?  @relation(fields: [courseId], references: [id])
}

model Payout {
  id                String      @id @default(uuid())
  payoutNumber      String      @unique
  
  sellerId          String
  seller            User        @relation("SellerPayouts", fields: [sellerId], references: [id], onDelete: Cascade)
  
  amount            Float
  method            String      // "bank" | "paypal" | "crypto" | "shamcash" etc.
  methodDetails     Json        // نسخة من تفاصيل الدفع
  
  status            PayoutStatus @default(PENDING)
  
  // Order Relations
  orders            Order[]
  
  // Processing Info
  requestedAt       DateTime @default(now())
  processedAt       DateTime?
  completedAt       DateTime?
  
  // Admin Actions
  approvedBy        String?  // admin user id
  approvedAt        DateTime?
  rejectedBy        String?  // admin user id
  rejectedAt        DateTime?
  paidAt            DateTime?
  
  transactionId     String?  // من البنك/PayPal/Blockchain
  adminNotes        String?
  rejectionReason   String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

// Enums
enum Role {
  SELLER
  CUSTOMER
  ADMIN
}

enum OrderStatus {
  PENDING
  PAID
  COMPLETED
  CANCELLED
  REFUNDED
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum PayoutStatus {
  PENDING
  PROCESSING
  PAID
  COMPLETED
  REJECTED
}

model Review {
  id          String   @id @default(uuid())
  rating      Int      // 1-5
  comment     String
  name        String
  
  isApproved  Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model AffiliateReferral {
  id          String          @id @default(uuid())
  commission  Float
  status      AffiliateStatus @default(PENDING)
  
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  
  affiliateUserId String
  affiliateUser   User         @relation(fields: [affiliateUserId], references: [id], onDelete: Cascade)
  
  orderId     String           @unique
  order       Order            @relation(fields: [orderId], references: [id])
}

enum AffiliateStatus {
  PENDING
  PAID
  CANCELLED
}

model CourseEnrollment {
  id          String   @id @default(uuid())
  
  // Student info
  studentName  String
  studentEmail String
  
  // Progress tracking
  progress    Int      @default(0) // 0-100%
  isCompleted Boolean  @default(false)
  completedAt DateTime?
  
  // Certificate
  certificateGenerated Boolean   @default(false)
  certificateUrl       String?
  
  // Engagement tracking
  lastAccessedAt  DateTime?
  totalWatchTime  Int @default(0) // بالدقائق
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  courseId    String
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  orderId     String?
  
  lessonProgress LessonProgress[]
  certificate    Certificate?
  
  @@unique([courseId, studentEmail]) // One enrollment per student per course
  @@index([studentEmail])
  @@index([courseId])
}


// ============================================
// SUBSCRIPTION SYSTEM
// ============================================

model SubscriptionPlan {
  id          String   @id @default(uuid())
  name        String   // "Basic", "Pro", "Premium"
  description String
  price       Float
  interval    String   // "month", "year"
  features    String[] @default([])
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscriptions Subscription[]
  
  @@index([userId])
}

model Subscription {
  id              String   @id @default(uuid())
  status          String   @default("active") // "active", "cancelled", "expired", "past_due"
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd  Boolean @default(false)
  
  // Stripe integration
  stripeSubscriptionId String? @unique
  stripeCustomerId     String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  planId      String
  plan        SubscriptionPlan @relation(fields: [planId], references: [id])
  
  customerId  String
  customer    User     @relation("CustomerSubscriptions", fields: [customerId], references: [id], onDelete: Cascade)
  
  @@index([customerId])
  @@index([planId])
}

// ============================================
// LEARNING PLATFORM
// ============================================

model Module {
  id          String   @id @default(uuid())
  title       String
  description String?
  order       Int      @default(0)
  isPublished Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  courseId    String
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons     Lesson[]
  
  @@index([courseId])
}

model Lesson {
  id          String   @id @default(uuid())
  title       String
  description String?
  content     String?  // محتوى نصي (Markdown)
  videoUrl    String?  // رابط الفيديو
  videoDuration Int?   // المدة بالثواني
  order       Int      @default(0)
  isPublished Boolean  @default(false)
  isFree      Boolean  @default(false) // درس مجاني للمعاينة
  
  // Resources
  attachments String[] @default([]) // روابط الملفات المرفقة
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  moduleId    String
  module      Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  
  quizzes     Quiz[]
  comments    Comment[]
  progress    LessonProgress[]
  
  @@index([moduleId])
}

model LessonProgress {
  id              String   @id @default(uuid())
  isCompleted     Boolean  @default(false)
  watchedDuration Int      @default(0) // بالثواني
  lastWatchedAt   DateTime @default(now())
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  lessonId        String
  lesson          Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  enrollmentId    String
  enrollment      CourseEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  
  @@unique([lessonId, enrollmentId])
  @@index([enrollmentId])
}

// ============================================
// QUIZZES & ASSESSMENTS
// ============================================

model Quiz {
  id          String   @id @default(uuid())
  title       String
  description String?
  passingScore Int     @default(70) // النسبة المطلوبة للنجاح
  timeLimit   Int?     // الوقت المحدد بالدقائق (اختياري)
  
  // Questions stored as JSON
  // Format: [{ question: string, type: 'multiple' | 'true-false', options: string[], correctAnswer: number | boolean }]
  questions   Json
  
  isPublished Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Can belong to lesson or course
  lessonId    String?
  lesson      Lesson?  @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  courseId    String?
  course      Course?  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  attempts    QuizAttempt[]
  
  @@index([lessonId])
  @@index([courseId])
}

model QuizAttempt {
  id          String   @id @default(uuid())
  score       Float    // النتيجة من 100
  answers     Json     // إجابات الطالب
  isPassed    Boolean
  timeSpent   Int?     // الوقت المستغرق بالدقائق
  
  completedAt DateTime @default(now())
  
  quizId      String
  quiz        Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  
  studentEmail String
  studentName  String
  
  @@index([quizId])
  @@index([studentEmail])
}

// ============================================
// CERTIFICATES
// ============================================

model Certificate {
  id              String   @id @default(uuid())
  certificateNumber String @unique
  studentName     String
  studentEmail    String
  courseName      String
  issueDate       DateTime @default(now())
  
  // Verification
  verificationCode String  @unique
  isVerified       Boolean @default(true)
  
  createdAt   DateTime @default(now())
  
  courseId        String
  course          Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  enrollmentId    String   @unique
  enrollment      CourseEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  
  @@index([studentEmail])
}

// ============================================
// COMMUNITY & ENGAGEMENT
// ============================================

model Comment {
  id          String   @id @default(uuid())
  content     String
  authorName  String
  authorEmail String
  likes       Int      @default(0)
  isApproved  Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  lessonId    String?
  lesson      Lesson?  @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  // Nested comments (replies)
  parentId    String?
  parent      Comment? @relation("CommentReplies", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  replies     Comment[] @relation("CommentReplies")
  
  @@index([lessonId])
  @@index([parentId])
}

model EmailSubscriber {
  id        String   @id @default(uuid())
  email     String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  
  @@index([createdAt])
}

// ============================================
// COUPONS & DISCOUNTS
// ============================================

model Coupon {
  id          String   @id @default(uuid())
  code        String   @unique
  type        String   // "percentage" | "fixed"
  value       Float    // القيمة (نسبة أو مبلغ ثابت)
  
  // Options
  minPurchase Float?   // الحد الأدنى للشراء
  maxDiscount Float?   // الحد الأقصى للخصم (للنسبة المئوية)
  usageLimit  Int?     // عدد مرات الاستخدام المسموح
  usageCount  Int      @default(0)
  
  // Dates
  startDate   DateTime?
  endDate     DateTime?
  
  // Restrictions
  productIds  String[] @default([])
  courseIds   String[] @default([])
  
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  orders      Order[]
  usages      CouponUsage[]
  
  @@index([userId])
  @@index([isActive])
}

model CouponUsage {
  id          String   @id @default(uuid())
  
  couponId    String
  coupon      Coupon   @relation(fields: [couponId], references: [id], onDelete: Cascade)
  
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id])
  
  discount    Float    // المبلغ المخصوم
  
  customerEmail String
  
  createdAt   DateTime @default(now())
  
  @@index([couponId])
  @@index([orderId])
  @@index([customerEmail])
}

// ============================================
// AFFILIATE SYSTEM
// ============================================

model AffiliateLink {
  id          String   @id @default(uuid())
  code        String   @unique
  
  // Target (واحد منهم فقط)
  productId   String?
  product     Product? @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  courseId    String?
  course      Course?  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  // Commission
  commissionType  String // "percentage" | "fixed"
  commissionValue Float
  
  // Stats
  clicks      Int      @default(0)
  salesCount  Int      @default(0)
  revenue     Float    @default(0)
  commission  Float    @default(0)
  
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  clickEvents AffiliateClick[]
  sales       AffiliateSale[]
  orders      Order[]
  
  @@index([userId])
  @@index([productId])
  @@index([courseId])
}

model AffiliateClick {
  id          String   @id @default(uuid())
  
  linkId      String
  link        AffiliateLink @relation(fields: [linkId], references: [id], onDelete: Cascade)
  
  ipAddress   String?
  userAgent   String?
  referer     String?
  
  createdAt   DateTime @default(now())
  
  @@index([linkId])
  @@index([createdAt])
}

model AffiliateSale {
  id          String   @id @default(uuid())
  
  linkId      String
  link        AffiliateLink @relation(fields: [linkId], references: [id])
  
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id])
  
  amount      Float    // قيمة الطلب
  commission  Float    // العمولة المستحقة
  status      String   @default("pending") // "pending" | "approved" | "paid"
  
  paidAt      DateTime?
  
  createdAt   DateTime @default(now())
  
  @@index([linkId])
  @@index([orderId])
  @@index([status])
}

