// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}


model User {
  id            String    @id @default(uuid())
  name          String
  email         String    @unique
  username      String    @unique
  password      String?
  phone         String?
  bio           String?
  avatar        String?
  coverImage    String?
  
  // Platform customization
  brandColor    String?   @default("#0ea5e9")
  website       String?
  facebook      String?
  instagram     String?
  twitter       String?
  
  // Bank/Wallet info
  bankName      String?
  accountNumber String?
  accountName   String?
  
  // Seller Balance (Escrow System)
  pendingBalance    Float    @default(0)  // Ø£Ø±Ø¨Ø§Ø­ Ù…Ø¹Ù„Ù‚Ø© (Ø·Ù„Ø¨Ø§Øª Ø£Ù‚Ù„ Ù…Ù† 7 Ø£ÙŠØ§Ù…)
  availableBalance  Float    @default(0)  // Ù…ØªØ§Ø­ Ù„Ù„Ø³Ø­Ø¨
  totalEarnings     Float    @default(0)  // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­
  
  // Payout Settings
  payoutMethod      String?  // "bank" | "paypal" | "crypto"
  bankDetails       Json?    // {bankName, accountNumber, iban, swift}
  paypalEmail       String?
  cryptoWallet      String?  // USDT address
  
  // Affiliate
  affiliateCode String?   @unique
  
  // Manual Payment Settings (Ù„Ù„Ø¨Ø§Ø¦Ø¹)
  shamCashNumber    String?
  omtNumber         String?
  zainCashNumber    String?
  vodafoneCash      String?
  mtncashNumber     String?
  
  // Appointments
  consultationPrice Float?   @default(0)
  
  role          Role      @default(SELLER)
  isActive      Boolean   @default(true)
  emailVerified Boolean   @default(false)
  isVerified    Boolean   @default(false)  // Blue checkmark badge
  preferredLanguage String @default("ar")  // ar, en, es
  
  // Google Calendar Integration
  googleCalendarAccessToken  String?
  googleCalendarRefreshToken String?
  googleCalendarTokenExpiry  DateTime?
  googleCalendarConnected    Boolean  @default(false)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  products      Product[]
  courses       Course[]
  appointments  Appointment[]
  orders        Order[]
  payouts       Payout[]  @relation("SellerPayouts")
  coupons       Coupon[]
  affiliateLinks AffiliateLink[]
  affiliateReferrals AffiliateReferral[]
  subscriptionPlans SubscriptionPlan[]
  subscriptions Subscription[] @relation("CustomerSubscriptions")
  sellerOrders  Order[]  @relation("SellerOrders")
  verifiedOrders Order[] @relation("OrderVerifier")
  availabilities Availability[]
  
  // New features
  bundles       Bundle[]
  sentNotifications Notification[] @relation("SentNotifications")
  receivedNotifications Notification[] @relation("ReceivedNotifications")
  automationSettings AutomationSettings?
}

model Product {
  id          String   @id @default(uuid())
  title       String
  slug        String?  // URL-friendly slug for direct linking
  description String
  price       Float
  image       String?
  fileUrl     String?  // Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø±Ù‚Ù…ÙŠ
  fileType    String?  @default("pdf") // pdf, video, zip, etc.
  
  category    String?
  tags        String[] @default([])
  
  // Media & Presentation (Phase 3)
  images      String[] @default([])    // Ù…Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±
  trailerUrl  String?                  // ÙÙŠØ¯ÙŠÙˆ ØªØ¹Ø±ÙŠÙÙŠ Ù„Ù„Ù…Ù†ØªØ¬
  previewFileUrl String?               // Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ø¬Ø§Ù†ÙŠØ© (Ù…Ù„Ù Ø£Ùˆ Ø¬Ø²Ø¡ Ù…Ù‚Ø·ÙˆØ¹ Ù…Ù‚Ø¯Ù…Ø§)
  
  // New fields
  isFree      Boolean  @default(false) // Ù…Ù†ØªØ¬ Ù…Ø¬Ø§Ù†ÙŠ
  isActive    Boolean  @default(true)  // Ù†Ø´Ø· Ø£Ùˆ Ù…Ø®ÙÙŠ
  displayOrder Int     @default(0)     // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ø±Ø¶
  duration    String?                  // Ù…Ø¯Ø© Ø§Ù„Ø¯ÙˆØ±Ø©
  sessions    Int?                     // Ø¹Ø¯Ø¯ Ø§Ù„Ø¬Ù„Ø³Ø§Øª
  features    String[] @default([])    // Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬
  
  // Pay What You Want (PWYW) Pricing
  minPrice    Float?   @default(0)     // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø¹Ø± (0 = free choice)
  suggestedPrice Float?                // Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚ØªØ±Ø­
  
  // Scarcity & Urgency Features
  stockLimit  Int?                     // Ø­Ø¯ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (null = unlimited)
  soldCount   Int      @default(0)     // Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
  offerExpiresAt DateTime?             // ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¹Ø±Ø¶
  
  // Reviews
  averageRating Float?   @default(0)
  reviewCount   Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  orderItems  OrderItem[]
  affiliateLinks AffiliateLink[]
  reviews     Review[]
  bundles     BundleProduct[]
  licenses    License[]
  changelogs  Changelog[]

  @@unique([userId, slug]) // Unique slug per creator
  @@index([userId])
  @@index([slug])
}

model Course {
  id          String   @id @default(uuid())
  title       String
  description String
  price       Float
  image       String?
  
  // Media (Phase 3)
  trailerUrl  String?  // ÙÙŠØ¯ÙŠÙˆ ØªØ¹Ø±ÙŠÙÙŠ Ù„Ù„ÙƒÙˆØ±Ø³
  
  // Course details
  duration    String?  // "4 Ø£Ø³Ø§Ø¨ÙŠØ¹"
  level       String?  // Ù…Ø¨ØªØ¯Ø¦ØŒ Ù…ØªÙˆØ³Ø·ØŒ Ù…ØªÙ‚Ø¯Ù…
  
  // Platform links
  zoomLink    String?
  meetLink    String?
  
  // Schedule
  startDate   DateTime?
  endDate     DateTime?
  sessions    Int?     // Ø¹Ø¯Ø¯ Ø§Ù„Ø¬Ù„Ø³Ø§Øª
  
  category    String?
  tags        String[]
  
  isActive    Boolean  @default(true)
  isCertificateEnabled Boolean @default(false) // Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„ØªØ®Ø±Ø¬ Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©
  
  // New settings
  allowComments Boolean @default(true)
  requiresQuiz  Boolean @default(false)
  certificateTemplate String? // Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„Ù…Ø®ØµØµ
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  orderItems  OrderItem[]
  enrollments CourseEnrollment[]
  modules     Module[]
  quizzes     Quiz[]
  certificates Certificate[]
  affiliateLinks AffiliateLink[]
}

model Appointment {
  id          String   @id @default(uuid())
  title       String
  description String?
  price       Float
  duration    Int      // Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚
  
  // Meeting details
  date        DateTime
  meetingLink String?
  status      AppointmentStatus @default(PENDING)
  
  // Customer info
  customerName  String?
  customerEmail String?
  customerPhone String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  orderId     String?
  order       Order?   @relation(fields: [orderId], references: [id])
}

model Availability {
  id          String   @id @default(uuid())
  
  dayOfWeek   Int      // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
  startTime   String   // e.g. "09:00"
  endTime     String   // e.g. "17:00"
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, dayOfWeek])
  @@index([userId])
}

model Order {
  id          String      @id @default(uuid())
  orderNumber String      @unique
  
  // Customer info
  customerName  String
  customerEmail String
  customerPhone String?
  totalAmount   Float
  status        OrderStatus @default(PENDING)
  
  // Commission & Escrow Fields
  platformFee       Float    @default(0)    // Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…Ù†ØµØ©
  sellerAmount      Float    @default(0)    // Ø­ØµØ© Ø§Ù„Ø¨Ø§Ø¦Ø¹
  
  // Seller Info
  sellerId          String?
  seller            User?    @relation("SellerOrders", fields: [sellerId], references: [id])
  
  // Payout Info
  payoutStatus      String   @default("pending")  // "pending" | "available" | "paid_out"
  availableAt       DateTime?                     // Ù…ØªÙ‰ ÙŠØµØ¨Ø­ Ù…ØªØ§Ø­ Ù„Ù„Ø³Ø­Ø¨
  paidOutAt         DateTime?
  payoutId          String?
  payout            Payout?  @relation(fields: [payoutId], references: [id])
  
  // Payment info
  paymentMethod String?
  paymentId     String?
  isPaid        Boolean   @default(false)
  paidAt        DateTime?
  
  // Manual Payment Fields
  paymentProof      String?   // Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„
  paymentNotes      String?   // Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ù† Ø§Ù„Ù…Ø´ØªØ±ÙŠ
  senderPhone       String?   // Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø³Ù„
  transactionRef    String?   // Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
  paymentCountry    String?   // Ø§Ù„Ø¯ÙˆÙ„Ø©
  paymentProvider   String?   // "shamcash" | "omt" | "zaincash" etc
  
  // Verification
  verifiedBy        String?
  verifier          User?     @relation("OrderVerifier", fields: [verifiedBy], references: [id])
  verifiedAt        DateTime?
  rejectionReason   String?
  
  // Crypto Payments (CoinRemitter)
  cryptoInvoiceId   String?
  cryptoAmount      Float?
  cryptoCoin        String?
  walletAddress     String?
  cryptoStatus      String?
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Coupon & Discount
  couponId    String?
  coupon      Coupon?  @relation(fields: [couponId], references: [id])
  discount    Float    @default(0)
  
  // Affiliate
  affiliateLinkId String?
  affiliateLink   AffiliateLink? @relation(fields: [affiliateLinkId], references: [id])
  
  // Relations
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  items       OrderItem[]
  appointments Appointment[]
  affiliateReferral AffiliateReferral?
  
  couponUsages   CouponUsage[]
  affiliateSales AffiliateSale[]
}

model OrderItem {
  id        String   @id @default(uuid())
  quantity  Int      @default(1)
  price     Float
  
  itemType  String   // "product" or "course"
  
  // Relations
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  productId String?
  product   Product? @relation(fields: [productId], references: [id])
  
  courseId  String?
  course    Course?  @relation(fields: [courseId], references: [id])
  
  bundleId  String?
  bundle    Bundle?  @relation(fields: [bundleId], references: [id])
  
  licenseKeyId String? // in case there's a license generated
}

model Payout {
  id                String      @id @default(uuid())
  payoutNumber      String      @unique
  
  sellerId          String
  seller            User        @relation("SellerPayouts", fields: [sellerId], references: [id], onDelete: Cascade)
  
  amount            Float
  method            String      // "bank" | "paypal" | "crypto" | "shamcash" etc.
  methodDetails     Json        // Ù†Ø³Ø®Ø© Ù…Ù† ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹
  
  status            PayoutStatus @default(PENDING)
  
  // Order Relations
  orders            Order[]
  
  // Processing Info
  requestedAt       DateTime @default(now())
  processedAt       DateTime?
  completedAt       DateTime?
  
  // Admin Actions
  approvedBy        String?  // admin user id
  approvedAt        DateTime?
  rejectedBy        String?  // admin user id
  rejectedAt        DateTime?
  paidAt            DateTime?
  
  transactionId     String?  // Ù…Ù† Ø§Ù„Ø¨Ù†Ùƒ/PayPal/Blockchain
  adminNotes        String?
  rejectionReason   String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

// Enums
enum Role {
  SELLER
  CUSTOMER
  ADMIN
}

enum OrderStatus {
  PENDING
  PAID
  COMPLETED
  CANCELLED
  REFUNDED
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum PayoutStatus {
  PENDING
  PROCESSING
  PAID
  COMPLETED
  REJECTED
}

model Review {
  id          String   @id @default(uuid())
  rating      Int      // 1-5
  comment     String
  name        String
  
  isApproved  Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model AffiliateReferral {
  id          String          @id @default(uuid())
  commission  Float
  status      AffiliateStatus @default(PENDING)
  
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  
  affiliateUserId String
  affiliateUser   User         @relation(fields: [affiliateUserId], references: [id], onDelete: Cascade)
  
  orderId     String           @unique
  order       Order            @relation(fields: [orderId], references: [id])
}

enum AffiliateStatus {
  PENDING
  PAID
  CANCELLED
}

model CourseEnrollment {
  id          String   @id @default(uuid())
  
  // Student info
  studentName  String
  studentEmail String
  
  // Progress tracking
  progress    Int      @default(0) // 0-100%
  isCompleted Boolean  @default(false)
  completedAt DateTime?
  
  // Certificate
  certificateGenerated Boolean   @default(false)
  certificateUrl       String?
  
  // Engagement tracking
  lastAccessedAt  DateTime?
  totalWatchTime  Int @default(0) // Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  courseId    String
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  orderId     String?
  
  lessonProgress LessonProgress[]
  certificate    Certificate?
  
  @@unique([courseId, studentEmail]) // One enrollment per student per course
  @@index([studentEmail])
  @@index([courseId])
}


// ============================================
// SUBSCRIPTION SYSTEM
// ============================================

model SubscriptionPlan {
  id          String   @id @default(uuid())
  name        String   // "Basic", "Pro", "Premium"
  description String
  price       Float
  interval    String   // "month", "year"
  features    String[] @default([])
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscriptions Subscription[]
  
  @@index([userId])
}

model Subscription {
  id              String   @id @default(uuid())
  status          String   @default("active") // "active", "cancelled", "expired", "past_due"
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd  Boolean @default(false)
  
  // Stripe integration
  stripeSubscriptionId String? @unique
  stripeCustomerId     String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  planId      String
  plan        SubscriptionPlan @relation(fields: [planId], references: [id])
  
  customerId  String
  customer    User     @relation("CustomerSubscriptions", fields: [customerId], references: [id], onDelete: Cascade)
  
  @@index([customerId])
  @@index([planId])
}

// ============================================
// LEARNING PLATFORM
// ============================================

model Module {
  id          String   @id @default(uuid())
  title       String
  description String?
  order       Int      @default(0)
  isPublished Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  courseId    String
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons     Lesson[]
  
  @@index([courseId])
}

model Lesson {
  id          String   @id @default(uuid())
  title       String
  description String?
  content     String?  // Ù…Ø­ØªÙˆÙ‰ Ù†ØµÙŠ (Markdown)
  videoUrl    String?  // Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
  videoDuration Int?   // Ø§Ù„Ù…Ø¯Ø© Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ
  order       Int      @default(0)
  isPublished Boolean  @default(false)
  isFree      Boolean  @default(false) // Ø¯Ø±Ø³ Ù…Ø¬Ø§Ù†ÙŠ Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
  
  // Resources
  attachments String[] @default([]) // Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙÙ‚Ø©
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  moduleId    String
  module      Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  
  quizzes     Quiz[]
  comments    Comment[]
  progress    LessonProgress[]
  
  @@index([moduleId])
}

model LessonProgress {
  id              String   @id @default(uuid())
  isCompleted     Boolean  @default(false)
  watchedDuration Int      @default(0) // Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ
  lastWatchedAt   DateTime @default(now())
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  lessonId        String
  lesson          Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  enrollmentId    String
  enrollment      CourseEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  
  @@unique([lessonId, enrollmentId])
  @@index([enrollmentId])
}

// ============================================
// QUIZZES & ASSESSMENTS
// ============================================

model Quiz {
  id          String   @id @default(uuid())
  title       String
  description String?
  passingScore Int     @default(70) // Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„Ù†Ø¬Ø§Ø­
  timeLimit   Int?     // Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯ Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
  
  // Questions stored as JSON
  // Format: [{ question: string, type: 'multiple' | 'true-false', options: string[], correctAnswer: number | boolean }]
  questions   Json
  
  isPublished Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Can belong to lesson or course
  lessonId    String?
  lesson      Lesson?  @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  courseId    String?
  course      Course?  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  attempts    QuizAttempt[]
  
  @@index([lessonId])
  @@index([courseId])
}

model QuizAttempt {
  id          String   @id @default(uuid())
  score       Float    // Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù…Ù† 100
  answers     Json     // Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨
  isPassed    Boolean
  timeSpent   Int?     // Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³ØªØºØ±Ù‚ Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚
  
  completedAt DateTime @default(now())
  
  quizId      String
  quiz        Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  
  studentEmail String
  studentName  String
  
  @@index([quizId])
  @@index([studentEmail])
}

// ============================================
// CERTIFICATES
// ============================================

model Certificate {
  id              String   @id @default(uuid())
  certificateNumber String @unique
  studentName     String
  studentEmail    String
  courseName      String
  issueDate       DateTime @default(now())
  
  // Verification
  verificationCode String  @unique
  isVerified       Boolean @default(true)
  
  createdAt   DateTime @default(now())
  
  courseId        String
  course          Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  enrollmentId    String   @unique
  enrollment      CourseEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  
  @@index([studentEmail])
}

// ============================================
// COMMUNITY & ENGAGEMENT
// ============================================

model Comment {
  id          String   @id @default(uuid())
  content     String
  authorName  String
  authorEmail String
  likes       Int      @default(0)
  isApproved  Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  lessonId    String?
  lesson      Lesson?  @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  // Nested comments (replies)
  parentId    String?
  parent      Comment? @relation("CommentReplies", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  replies     Comment[] @relation("CommentReplies")
  
  @@index([lessonId])
  @@index([parentId])
}

model EmailSubscriber {
  id        String   @id @default(uuid())
  email     String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  
  @@index([createdAt])
}

// ============================================
// COUPONS & DISCOUNTS
// ============================================

model Coupon {
  id          String   @id @default(uuid())
  code        String   @unique
  type        String   // "percentage" | "fixed"
  value       Float    // Ø§Ù„Ù‚ÙŠÙ…Ø© (Ù†Ø³Ø¨Ø© Ø£Ùˆ Ù…Ø¨Ù„Øº Ø«Ø§Ø¨Øª)
  
  // Options
  minPurchase Float?   // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø´Ø±Ø§Ø¡
  maxDiscount Float?   // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø®ØµÙ… (Ù„Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©)
  usageLimit  Int?     // Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø³Ù…ÙˆØ­
  usageCount  Int      @default(0)
  
  // Dates
  startDate   DateTime?
  endDate     DateTime?
  
  // Restrictions
  productIds  String[] @default([])
  courseIds   String[] @default([])
  
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  orders      Order[]
  usages      CouponUsage[]
  
  @@index([userId])
  @@index([isActive])
}

model CouponUsage {
  id          String   @id @default(uuid())
  
  couponId    String
  coupon      Coupon   @relation(fields: [couponId], references: [id], onDelete: Cascade)
  
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id])
  
  discount    Float    // Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø®ØµÙˆÙ…
  
  customerEmail String
  
  createdAt   DateTime @default(now())
  
  @@index([couponId])
  @@index([orderId])
  @@index([customerEmail])
}

// ============================================
// AFFILIATE SYSTEM
// ============================================

model AffiliateLink {
  id          String   @id @default(uuid())
  code        String   @unique
  
  // Target (ÙˆØ§Ø­Ø¯ Ù…Ù†Ù‡Ù… ÙÙ‚Ø·)
  productId   String?
  product     Product? @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  courseId    String?
  course      Course?  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  // Commission
  commissionType  String // "percentage" | "fixed"
  commissionValue Float
  
  // Stats
  clicks      Int      @default(0)
  salesCount  Int      @default(0)
  revenue     Float    @default(0)
  commission  Float    @default(0)
  
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  clickEvents AffiliateClick[]
  sales       AffiliateSale[]
  orders      Order[]
  
  @@index([userId])
  @@index([productId])
  @@index([courseId])
}

model AffiliateClick {
  id          String   @id @default(uuid())
  
  linkId      String
  link        AffiliateLink @relation(fields: [linkId], references: [id], onDelete: Cascade)
  
  ipAddress   String?
  userAgent   String?
  referer     String?
  
  createdAt   DateTime @default(now())
  
  @@index([linkId])
  @@index([createdAt])
}

model AffiliateSale {
  id          String   @id @default(uuid())
  
  linkId      String
  link        AffiliateLink @relation(fields: [linkId], references: [id])
  
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id])
  
  amount      Float    // Ù‚ÙŠÙ…Ø© Ø§Ù„Ø·Ù„Ø¨
  commission  Float    // Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©
  status      String   @default("pending") // "pending" | "approved" | "paid"
  
  paidAt      DateTime?
  
  createdAt   DateTime @default(now())
  
  @@index([linkId])
  @@index([orderId])
  @@index([status])
}

// ============================================
// BUNDLES & PACKAGES
// ============================================

model Bundle {
  id          String   @id @default(uuid())
  title       String
  description String
  price       Float
  image       String?
  slug        String?  @unique
  
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  products    BundleProduct[]
  orderItems  OrderItem[]
  
  @@index([userId])
}

model BundleProduct {
  id          String   @id @default(uuid())
  bundleId    String
  bundle      Bundle   @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  @@unique([bundleId, productId])
}

// ============================================
// LICENSING SYSTEM
// ============================================

model License {
  id              String   @id @default(uuid())
  type            String   // "PERSONAL" | "COMMERCIAL" | "EXTENDED"
  price           Float
  features        String[] @default([])
  
  productId       String
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  keys            LicenseKey[]
  
  @@unique([productId, type])
}

model LicenseKey {
  id              String   @id @default(uuid())
  key             String   @unique
  isUsed          Boolean  @default(false)
  validatedAt     DateTime?
  
  licenseId       String
  license         License  @relation(fields: [licenseId], references: [id], onDelete: Cascade)
  
  orderId         String?  @unique
  
  createdAt       DateTime @default(now())
  
  @@index([key])
}

// ============================================
// CHANGELOG & UPDATES
// ============================================

model Changelog {
  id          String   @id @default(uuid())
  version     String
  content     String   // Markdown description of changes
  
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  
  @@index([productId])
}

// ============================================
// NOTIFICATIONS & MESSAGING
// ============================================

model Notification {
  id          String   @id @default(uuid())
  type        String   // "EMAIL" | "INTERNAL"
  title       String
  content     String
  isRead      Boolean  @default(false)
  
  senderId    String?
  sender      User?    @relation("SentNotifications", fields: [senderId], references: [id])
  
  receiverEmail String?
  receiverId  String?
  receiver    User?    @relation("ReceivedNotifications", fields: [receiverId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  
  @@index([receiverId])
}

// ============================================
// AUTOMATION SYSTEM
// ============================================

model AutomationSettings {
  id        String  @id @default(uuid())
  userId    String  @unique
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 1. Welcome Email
  welcomeEmailEnabled   Boolean @default(false)
  welcomeEmailSubject   String  @default("Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ! ğŸ‰")
  welcomeEmailBody      String  @default("")

  // 2. Abandoned Cart Reminders
  cartReminder1Enabled  Boolean @default(false)
  cartReminder2Enabled  Boolean @default(false)
  cartReminder3Enabled  Boolean @default(false)
  cartReminder3Discount Float?
  cartReminder1Body     String  @default("")
  cartReminder2Body     String  @default("")
  cartReminder3Body     String  @default("")

  // 3. Post-Purchase Emails
  postPurchase7Enabled  Boolean @default(false)
  postPurchase30Enabled Boolean @default(false)
  postPurchase7Body     String  @default("")
  postPurchase30Body    String  @default("")

  // 4. Subscription Reminders
  subRemindersEnabled   Boolean @default(false)

  // 5. Seller Notifications
  notifyOnSale          Boolean @default(true)
  notifyOnReview        Boolean @default(true)
  notifyOnQuestion      Boolean @default(true)
  notifyOnCompletion    Boolean @default(true)
  notifyOnRefund        Boolean @default(true)
  notifyMethods         String  @default("both") // "email" | "internal" | "both"

  // 6. Reports
  reportFrequency       String  @default("weekly") // "daily" | "weekly" | "monthly"
  reportEnabled         Boolean @default(false)

  // 7. Marketing Automation
  marketingEnabled      Boolean @default(false)
  inactiveUserDays      Int     @default(30)
  inactiveUserDiscount  Float?

  // 8. Educational Follow-up
  eduFollowupEnabled    Boolean @default(false)
  inactivityDays        Int     @default(7)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model AbandonedCart {
  id            String   @id @default(uuid())
  customerEmail String
  customerName  String?
  productIds    String[]
  productNames  String[]
  sellerId      String
  totalAmount   Float

  reminder1SentAt DateTime?
  reminder2SentAt DateTime?
  reminder3SentAt DateTime?
  isConverted     Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sellerId])
  @@index([customerEmail])
  @@index([isConverted])
}

model EmailLog {
  id          String   @id @default(uuid())
  type        String   // "welcome" | "cart_reminder_1/2/3" | "post_purchase_7/30" | "report" | "sub_reminder" | "edu_followup" | "marketing"
  toEmail     String
  toName      String?
  subject     String
  status      String   @default("sent") // "sent" | "failed"
  errorMessage String?
  sellerId    String

  createdAt   DateTime @default(now())

  @@index([sellerId])
  @@index([type])
  @@index([createdAt])
}

model ScheduledEmail {
  id           String   @id @default(uuid())
  sellerId     String
  subject      String
  body         String
  targetGroup  String   @default("all") // "all" | "inactive" | "buyers"
  scheduledAt  DateTime
  sentAt       DateTime?
  status       String   @default("pending") // "pending" | "sent" | "cancelled"
  discountCode String?
  recipientCount Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sellerId])
  @@index([scheduledAt])
  @@index([status])
}

